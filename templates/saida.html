{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2 class="text-primary text-center mb-4">Saída de Roupas</h2>

  <!-- Layout dividido em 4 quadrantes -->
  <div class="row">
    <!-- 1. Tipos disponíveis -->
    <div class="col-md-6">
      <h5 class="text-center">Tipos no Estoque</h5>
      <div id="tiposEstoque" class="d-flex flex-wrap justify-content-center mb-3">
        {% for tipo in tipos %}
          <button class="btn btn-outline-primary m-1" onclick="mostrarDetalhes('{{ tipo }}')">
            {{ tipo }}
          </button>
        {% endfor %}
      </div>
    </div>

    <!-- 2. Tipos solicitados pela produção -->
    <div class="col-md-6">
      <h5 class="text-center">Solicitado pela Produção</h5>
      <ul class="list-group">
        {% for item in solicitacao %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ item.tipo }} - {{ item.tamanho }}</span>
            <span><strong>{{ item.quantidade }}</strong></span>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="row mt-4">
    <!-- 3. Detalhes do tipo clicado -->
    <div class="col-md-6">
      <h5 class="text-center">Lotes Disponíveis</h5>
      <div id="detalhesTipo"></div>
    </div>

    <!-- 4. Resumo de seleção -->
    <div class="col-md-6">
      <h5 class="text-center">Resumo da Saída</h5>
      <form method="POST">
        <table class="table table-sm" id="resumoSaida">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Tamanho</th>
              <th>Lote</th>
              <th>Qtd</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <input type="hidden" name="numero_ordem" value="{{ numero_ordem }}">
        <button type="submit" class="btn btn-success w-100">
          <i class="bi bi-check-circle"></i> Confirmar Saída
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  const roupas = {{ roupas | tojson | safe }};
  const resumo = [];

  function mostrarDetalhes(tipo) {
    const container = document.getElementById("detalhesTipo");
    const filtrados = roupas.filter(r => r.tipo === tipo);

    if (filtrados.length === 0) {
      container.innerHTML = '<p class="text-danger">Nenhum lote encontrado.</p>';
      return;
    }

    let html = '<table class="table table-bordered"><thead><tr><th>Tamanho</th><th>Lote</th><th>Validade</th><th>Qtd</th><th>Selecionar</th></tr></thead><tbody>';
    filtrados.forEach(r => {
      html += `<tr>
        <td>${r.tamanho}</td>
        <td>${r.lote}</td>
        <td>${r.validade}</td>
        <td>${r.quantidade}</td>
        <td>
          <input type="number" min="1" max="${r.quantidade}" class="form-control form-control-sm" id="qtd_${r.tipo}_${r.tamanho}_${r.lote}" placeholder="Qtd">
          <button class="btn btn-sm btn-primary mt-1" onclick="adicionarResumo('${r.tipo}', '${r.tamanho}', '${r.lote}')">
            Adicionar
          </button>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function adicionarResumo(tipo, tamanho, lote) {
    const input = document.getElementById(`qtd_${tipo}_${tamanho}_${lote}`);
    const qtd = parseInt(input.value);
    if (!qtd || qtd <= 0) return alert('Informe a quantidade.');

    const tbody = document.querySelector('#resumoSaida tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="hidden" name="tipo[]" value="${tipo}">${tipo}</td>
      <td><input type="hidden" name="tamanho[]" value="${tamanho}">${tamanho}</td>
      <td><input type="hidden" name="lote[]" value="${lote}">${lote}</td>
      <td><input type="hidden" name="quantidade[]" value="${qtd}">${qtd}</td>
      <td><button class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.remove()">Remover</button></td>
    `;
    tbody.appendChild(tr);
    input.value = '';
  }
</script>
{% endblock %}
